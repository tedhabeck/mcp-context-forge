# ===============================================================
# ‚òÅÔ∏è  ContextForge ‚ñ∏ Build, Cache & Deploy to IBM Code Engine
# ===============================================================
#
# This workflow:
#   - Restores / updates a local **BuildKit layer cache**  ‚ùÑÔ∏è
#   - Builds the Docker image from **Containerfile.lite**  üèóÔ∏è
#   - Pushes the image to **IBM Container Registry (ICR)** üì§
#   - Creates / updates an **IBM Cloud Code Engine** app   üöÄ
#
# ---------------------------------------------------------------
# Required repository **secrets** (environment: production)
# ---------------------------------------------------------------
#  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#  ‚îÇ Secret name                      ‚îÇ Purpose                ‚îÇ
#  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
#  ‚îÇ IBM_CLOUD_API_KEY                ‚îÇ IBM Cloud IAM API key  ‚îÇ
#  ‚îÇ CF_JWT_SECRET_KEY                ‚îÇ JWT signing key        ‚îÇ
#  ‚îÇ CF_BASIC_AUTH_PASSWORD           ‚îÇ Admin UI password      ‚îÇ
#  ‚îÇ CF_AUTH_ENCRYPTION_SECRET        ‚îÇ Stored-secret cipher   ‚îÇ
#  ‚îÇ CF_PLATFORM_ADMIN_PASSWORD       ‚îÇ Bootstrap admin pass   ‚îÇ
#  ‚îÇ CF_DEFAULT_USER_PASSWORD         ‚îÇ Default user pass      ‚îÇ
#  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#
# ---------------------------------------------------------------
# Required repository **variables** (environment: production)
# ---------------------------------------------------------------
#  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#  ‚îÇ Variable name              ‚îÇ Example value                ‚îÇ
#  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
#  ‚îÇ IBM_CLOUD_REGION           ‚îÇ us-south                     ‚îÇ
#  ‚îÇ REGISTRY_HOSTNAME          ‚îÇ us.icr.io                    ‚îÇ
#  ‚îÇ ICR_NAMESPACE              ‚îÇ myspace                      ‚îÇ
#  ‚îÇ APP_NAME                   ‚îÇ mcpgateway                   ‚îÇ
#  ‚îÇ CODE_ENGINE_PROJECT        ‚îÇ my-ce-project                ‚îÇ
#  ‚îÇ CODE_ENGINE_REGISTRY_SECRET‚îÇ my-registry-secret           ‚îÇ
#  ‚îÇ CODE_ENGINE_PORT           ‚îÇ "4444"                       ‚îÇ
#  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
# * Note: CODE_ENGINE_REGISTRY_SECRET is the name of the CE
#         registry pull secret, not the secret value itself.
# Triggers:
#   - Every push to `main`
#   - Syncs the Code Engine secret `mcpgateway-dev` from
#     `.env.example` + GitHub Secrets (merge; never logged).
# ---------------------------------------------------------------

name: Deploy to IBM Code Engine

on:
  push:
    branches: ["main"]

# -----------------------------------------------------------------
# Minimal permissions (Principle of Least Privilege)
# -----------------------------------------------------------------
permissions:
  contents: read

# -----------------------------------------------------------------
# Global environment (secrets & variables)
# -----------------------------------------------------------------
env:
  # Build metadata
  GITHUB_SHA: ${{ github.sha }}
  CACHE_DIR: /tmp/.buildx-cache # BuildKit layer cache dir

  # IBM Cloud region (variable)
  IBM_CLOUD_REGION: ${{ vars.IBM_CLOUD_REGION }}

  # Registry coordinates (variables)
  REGISTRY_HOSTNAME: ${{ vars.REGISTRY_HOSTNAME }}
  ICR_NAMESPACE: ${{ vars.ICR_NAMESPACE }}

  # Image / app naming (variables)
  IMAGE_NAME: ${{ vars.APP_NAME }}
  IMAGE_TAG: ${{ github.sha }}

  # Code Engine deployment (variables)
  CODE_ENGINE_APP_NAME: ${{ vars.APP_NAME }}
  CODE_ENGINE_PROJECT: ${{ vars.CODE_ENGINE_PROJECT }}
  CODE_ENGINE_REGISTRY_SECRET: ${{ vars.CODE_ENGINE_REGISTRY_SECRET }}
  PORT: ${{ vars.CODE_ENGINE_PORT }}

jobs:
  build-push-deploy:
    name: üöÄ Build, Cache, Push & Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      # -----------------------------------------------------------
      # 0Ô∏è‚É£  Checkout repository
      # -----------------------------------------------------------
      - name: ‚¨áÔ∏è  Checkout source
        uses: actions/checkout@v5

      # -----------------------------------------------------------
      # 1Ô∏è‚É£  Validate required secrets & variables
      # -----------------------------------------------------------
      - name: ‚úÖ  Validate configuration
        env:
          CF_IBM_CLOUD_API_KEY: ${{ secrets.IBM_CLOUD_API_KEY }}
          CF_JWT_SECRET_KEY: ${{ secrets.CF_JWT_SECRET_KEY }}
          CF_BASIC_AUTH_PASSWORD: ${{ secrets.CF_BASIC_AUTH_PASSWORD }}
          CF_AUTH_ENCRYPTION_SECRET: ${{ secrets.CF_AUTH_ENCRYPTION_SECRET }}
          CF_PLATFORM_ADMIN_PASSWORD: ${{ secrets.CF_PLATFORM_ADMIN_PASSWORD }}
          CF_DEFAULT_USER_PASSWORD: ${{ secrets.CF_DEFAULT_USER_PASSWORD }}
        run: |
          missing=()
          for var in CF_IBM_CLOUD_API_KEY CF_JWT_SECRET_KEY CF_BASIC_AUTH_PASSWORD \
                     CF_AUTH_ENCRYPTION_SECRET CF_PLATFORM_ADMIN_PASSWORD \
                     CF_DEFAULT_USER_PASSWORD; do
            if [ -z "${!var}" ]; then
              missing+=("$var")
            fi
          done
          for var in IBM_CLOUD_REGION REGISTRY_HOSTNAME ICR_NAMESPACE \
                     IMAGE_NAME CODE_ENGINE_APP_NAME CODE_ENGINE_PROJECT \
                     CODE_ENGINE_REGISTRY_SECRET PORT; do
            if [ -z "${!var}" ]; then
              missing+=("$var")
            fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error::Required secrets/variables are empty or unconfigured: ${missing[*]}"
            exit 1
          fi
          echo "All required secrets and variables are present."

      # -----------------------------------------------------------
      # 2Ô∏è‚É£  Set up Docker Buildx
      # -----------------------------------------------------------
      - name: üõ†Ô∏è  Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      # -----------------------------------------------------------
      # 3Ô∏è‚É£  Restore BuildKit layer cache
      # -----------------------------------------------------------
      - name: üîÑ  Restore BuildKit cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_DIR }}
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: ${{ runner.os }}-buildx-

      # -----------------------------------------------------------
      # 4Ô∏è‚É£  Install IBM Cloud CLI + plugins & login
      # -----------------------------------------------------------
      - name: üß∞  Install IBM Cloud CLI
        uses: IBM/actions-ibmcloud-cli@v1
        with:
          api_key: ${{ secrets.IBM_CLOUD_API_KEY }}
          region: ${{ vars.IBM_CLOUD_REGION }}
          plugins: container-registry, code-engine

      # -----------------------------------------------------------
      # 5Ô∏è‚É£  Authenticate to IBM Cloud Code Engine project
      # -----------------------------------------------------------
      - name: üîê  IBM Cloud Code Engine login
        run: |
          ibmcloud cr region-set "$IBM_CLOUD_REGION"
          ibmcloud cr login
          ibmcloud ce project select --name "$CODE_ENGINE_PROJECT"

      # -----------------------------------------------------------
      # 6Ô∏è‚É£  Build & tag image (cache-aware, amd64 platform)
      # -----------------------------------------------------------
      - name: üèóÔ∏è  Build Docker image (with cache)
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file Containerfile.lite \
            --tag "$REGISTRY_HOSTNAME/$ICR_NAMESPACE/$IMAGE_NAME:$IMAGE_TAG" \
            --cache-from type=local,src=${{ env.CACHE_DIR }} \
            --cache-to   type=local,dest=${{ env.CACHE_DIR }},mode=max \
            --load \
            .

      # -----------------------------------------------------------
      # 7Ô∏è‚É£  Push image to IBM Container Registry
      # -----------------------------------------------------------
      - name: üì§  Push image to ICR
        run: |
          docker push "$REGISTRY_HOSTNAME/$ICR_NAMESPACE/$IMAGE_NAME:$IMAGE_TAG"

      # -----------------------------------------------------------
      # 8Ô∏è‚É£  Build .env from template + GitHub Secrets, sync to CE
      # -----------------------------------------------------------
      - name: üîë  Sync Code Engine secrets
        env:
          CF_JWT_SECRET_KEY: ${{ secrets.CF_JWT_SECRET_KEY }}
          CF_BASIC_AUTH_PASSWORD: ${{ secrets.CF_BASIC_AUTH_PASSWORD }}
          CF_AUTH_ENCRYPTION_SECRET: ${{ secrets.CF_AUTH_ENCRYPTION_SECRET }}
          CF_PLATFORM_ADMIN_PASSWORD: ${{ secrets.CF_PLATFORM_ADMIN_PASSWORD }}
          CF_DEFAULT_USER_PASSWORD: ${{ secrets.CF_DEFAULT_USER_PASSWORD }}
        run: |
          # Ensure .env.deploy is removed on exit (success or failure)
          trap 'rm -f .env.deploy' EXIT

          # Build .env from .env.example, replacing secret placeholders.
          # Uses Python to avoid shell quoting issues (sed delimiter
          # collisions with |, &, \) and grep exit-code edge cases.
          python3 -c "
          import os, sys
          replacements = {
              'JWT_SECRET_KEY': os.environ['CF_JWT_SECRET_KEY'],
              'BASIC_AUTH_PASSWORD': os.environ['CF_BASIC_AUTH_PASSWORD'],
              'AUTH_ENCRYPTION_SECRET': os.environ['CF_AUTH_ENCRYPTION_SECRET'],
              'PLATFORM_ADMIN_PASSWORD': os.environ['CF_PLATFORM_ADMIN_PASSWORD'],
              'DEFAULT_USER_PASSWORD': os.environ['CF_DEFAULT_USER_PASSWORD'],
          }
          replaced = set()
          with open('.env.example') as f:
              lines = f.readlines()
          with open('.env.deploy', 'w') as out:
              for line in lines:
                  stripped = line.lstrip()
                  if '=' in stripped and not stripped.startswith('#'):
                      key = stripped.split('=', 1)[0]
                      if key in replacements:
                          val = replacements[key]
                          if '\n' in val or '\r' in val:
                              print(f'::error::Secret for {key} contains embedded newlines')
                              raise SystemExit(1)
                          out.write(f'{key}={val}\n')
                          replaced.add(key)
                          continue
                  out.write(line)
          missing = set(replacements) - replaced
          if missing:
              print(f'::error::Keys not found in .env.example: {missing}')
              print('Hint: check that .env.example uses KEY=value format (no spaces around =)')
              sys.exit(1)
          "

          echo "‚úÖ Generated .env.deploy from template + GitHub Secrets"

          # Update the secret if it exists, otherwise create it.
          # 'secret update --from-env-file' merges keys (does not prune
          # removed keys), so stale keys may linger if .env.example drops
          # a variable. This is benign (unused env vars) and far safer
          # than delete+create which leaves no secret if create fails.
          if ibmcloud ce secret get --name mcpgateway-dev > /dev/null 2>&1; then
            ibmcloud ce secret update --name mcpgateway-dev --from-env-file .env.deploy
          else
            ibmcloud ce secret create --name mcpgateway-dev --format generic --from-env-file .env.deploy
          fi

          echo "‚úÖ Code Engine secret 'mcpgateway-dev' synced"

      # -----------------------------------------------------------
      # 9Ô∏è‚É£  Deploy (create or update) Code Engine application
      # -----------------------------------------------------------
      - name: üöÄ  Deploy to Code Engine
        run: |
          if ibmcloud ce application get --name "$CODE_ENGINE_APP_NAME" > /dev/null 2>&1; then
            echo "üîÅ Updating existing application..."
            ibmcloud ce application update \
              --name  "$CODE_ENGINE_APP_NAME" \
              --image "$REGISTRY_HOSTNAME/$ICR_NAMESPACE/$IMAGE_NAME:$IMAGE_TAG" \
              --registry-secret "$CODE_ENGINE_REGISTRY_SECRET" \
              --env-from-secret mcpgateway-dev \
              --cpu 1 --memory 2G
          else
            echo "üÜï Creating new application..."
            ibmcloud ce application create \
              --name  "$CODE_ENGINE_APP_NAME" \
              --image "$REGISTRY_HOSTNAME/$ICR_NAMESPACE/$IMAGE_NAME:$IMAGE_TAG" \
              --registry-secret "$CODE_ENGINE_REGISTRY_SECRET" \
              --port  "$PORT" \
              --env-from-secret mcpgateway-dev \
              --cpu 1 --memory 2G
          fi

      # -----------------------------------------------------------
      # üîü  Show deployment status
      # -----------------------------------------------------------
      - name: üìà  Display deployment status
        run: ibmcloud ce application get --name "$CODE_ENGINE_APP_NAME"

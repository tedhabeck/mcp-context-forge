# templates/secret-postgres.yaml
{{- if and .Values.postgres.enabled (not .Values.postgres.existingSecret) (not .Values.postgres.external.enabled) }}
apiVersion: v1
kind: Secret
metadata:
  name: "{{ include "mcp-stack.postgresSecretName" . | trim }}"
type: Opaque
stringData:
  # add the keys the Postgres image needs
  POSTGRES_USER:      {{ .Values.postgres.credentials.user      | quote }}
  POSTGRES_PASSWORD:  {{ .Values.postgres.credentials.password  | quote }}
  POSTGRES_DB:        {{ .Values.postgres.credentials.database  | quote }}
{{- end }}
---
{{- /* External PostgreSQL secret - created when external is enabled without an existingSecret */}}
{{- if and .Values.postgres.external.enabled (not .Values.postgres.external.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: "{{ include "mcp-stack.fullname" . }}-postgres-external"
  labels:
    {{- include "mcp-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: external-postgres
type: Opaque
stringData:
  {{- /* Use the configured key names for CloudNativePG compatibility */}}
  {{ .Values.postgres.external.hostKey | default "host" }}:     {{ .Values.postgres.external.host | quote }}
  {{ .Values.postgres.external.portKey | default "port" }}:     {{ .Values.postgres.external.port | default 5432 | toString | quote }}
  {{ .Values.postgres.external.databaseKey | default "dbname" }}:  {{ .Values.postgres.external.database | quote }}
  {{ .Values.postgres.external.userKey | default "user" }}:     {{ .Values.postgres.external.user | quote }}
  {{ .Values.postgres.external.passwordKey | default "password" }}: {{ .Values.postgres.external.password | quote }}
{{- end }}

{{- /*
Ingress
- Gateway and Fast-Time Server ingress are rendered independently so they can be enabled separately.
*/ -}}
{{- $fullName := include "mcp-stack.fullname" . -}}
{{- if .Values.mcpContextForge.ingress.enabled }}
{{- $gatewayIngress := .Values.mcpContextForge.ingress -}}
{{- $gatewayClassName := lower ($gatewayIngress.className | default "") -}}
{{- $gatewayAnnotations := dict -}}
{{- if and $gatewayIngress.tls.enabled (contains "nginx" $gatewayClassName) -}}
{{- $_ := set $gatewayAnnotations "nginx.ingress.kubernetes.io/ssl-redirect" "true" -}}
{{- $_ := set $gatewayAnnotations "nginx.ingress.kubernetes.io/force-ssl-redirect" "true" -}}
{{- $_ := set $gatewayAnnotations "nginx.ingress.kubernetes.io/hsts" "true" -}}
{{- $_ := set $gatewayAnnotations "nginx.ingress.kubernetes.io/hsts-max-age" "31536000" -}}
{{- $_ := set $gatewayAnnotations "nginx.ingress.kubernetes.io/hsts-include-subdomains" "true" -}}
{{- end -}}
{{- range $key, $value := ($gatewayIngress.annotations | default dict) -}}
{{- $_ := set $gatewayAnnotations $key (toString $value) -}}
{{- end -}}
{{- $gatewayTlsSecretName := $gatewayIngress.tls.secretName | default (printf "%s-ingress-tls" $fullName) -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $fullName }}-ingress
  {{- if $gatewayAnnotations }}
  annotations:
    {{- range $key, $value := $gatewayAnnotations }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
  {{- end }}
spec:
  ingressClassName: {{ $gatewayIngress.className }}
  {{- if $gatewayIngress.tls.enabled }}
  tls:
    - hosts:
        - {{ $gatewayIngress.host }}
      secretName: {{ $gatewayTlsSecretName }}
  {{- end }}
  rules:
    - host: {{ $gatewayIngress.host }}
      http:
        paths:
          - path: {{ $gatewayIngress.path }}
            pathType: {{ $gatewayIngress.pathType }}
            backend:
              service:
                name: {{ $fullName }}-mcpgateway
                port:
                  number: {{ .Values.mcpContextForge.service.port }}
{{- end }}

{{- if and .Values.mcpFastTimeServer.enabled .Values.mcpFastTimeServer.ingress.enabled }}
{{- $fastTimeIngress := .Values.mcpFastTimeServer.ingress -}}
{{- $fastTimeClassName := lower ($fastTimeIngress.className | default "") -}}
{{- $fastTimeAnnotations := dict -}}
{{- if and $fastTimeIngress.tls.enabled (contains "nginx" $fastTimeClassName) -}}
{{- $_ := set $fastTimeAnnotations "nginx.ingress.kubernetes.io/ssl-redirect" "true" -}}
{{- $_ := set $fastTimeAnnotations "nginx.ingress.kubernetes.io/force-ssl-redirect" "true" -}}
{{- $_ := set $fastTimeAnnotations "nginx.ingress.kubernetes.io/hsts" "true" -}}
{{- $_ := set $fastTimeAnnotations "nginx.ingress.kubernetes.io/hsts-max-age" "31536000" -}}
{{- $_ := set $fastTimeAnnotations "nginx.ingress.kubernetes.io/hsts-include-subdomains" "true" -}}
{{- end -}}
{{- range $key, $value := ($fastTimeIngress.annotations | default dict) -}}
{{- $_ := set $fastTimeAnnotations $key (toString $value) -}}
{{- end -}}
{{- $fastTimeTlsSecretName := $fastTimeIngress.tls.secretName | default (printf "%s-fast-time-ingress-tls" $fullName) -}}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $fullName }}-fast-time-ingress
  {{- if $fastTimeAnnotations }}
  annotations:
    {{- range $key, $value := $fastTimeAnnotations }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
  {{- end }}
spec:
  ingressClassName: {{ $fastTimeIngress.className }}
  {{- if $fastTimeIngress.tls.enabled }}
  tls:
    - hosts:
        - {{ $fastTimeIngress.host }}
      secretName: {{ $fastTimeTlsSecretName }}
  {{- end }}
  rules:
    - host: {{ $fastTimeIngress.host }}
      http:
        paths:
          - path: {{ $fastTimeIngress.path }}
            pathType: {{ $fastTimeIngress.pathType }}
            backend:
              service:
                name: {{ $fullName }}-mcp-fast-time-server
                port:
                  number: {{ $fastTimeIngress.servicePort }}
{{- end }}
